<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  

    <title>The Thoht Project Management</title>
    <style>
        .defmargin{
            margin-top: 6px;
            margin-bottom: 12px;
        }
    </style>
   

  </head>
  <body>

        <nav class="navbar navbar-dark bg-dark">
            <a class="navbar-brand" href="#">The Thoht Project</a>
        </nav>

        <div id='alert' class='hide defmargin'></div>
        </div>
        <div class="row">
                <div class="container">
                    <button type="button" class="btn btn-outline-primary defmargin addrow">Add New</button>
                    <table id="recordsTable" class="table table-hover defmargin">
                        <thead>
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">Primary Text</th>
                                <th scope="col">Secondary Text</th>
                                <th scope="col">Author</th>
                                <th scope="col">Post Date</th>
                                <th scope="col">IsVisible</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>                       
                        </tbody>
                    </table> 
                </div>  
        </div>
        <div class="row">
                <div class="container">
                    <nav aria-label="...">
                        <ul class="pagination">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">1</a></li>
                        <li class="page-item active" aria-current="page">
                            <a class="page-link" href="#">2 <span class="sr-only">(current)</span></a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                        </li>
                        </ul>
                    </nav>
                </div>
        </div>
 
        <div class="modal" id ="quoteModal" data-id="" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title">Edit</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                    <form id="editform">
                        <div class="form-row">
                            <div class="col-2">
                                <label for="exampleInputEmail1">ID:</label>
                            </div>
                            <div class="col">
                                <input type="text" readonly class="form-control-plaintext" id="id" name="Id" value="">
                            </div>
                            <div class="col-2">
                                <label for="exampleInputEmail1">Post date:</label>
                            </div>
                            <div class="col">
                                <input type="text" readonly class="form-control-plaintext" id="postTime" name="PostTime" value="">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-2">
                                <label for="exampleInputEmail1">Author:</label>
                            </div>
                            <div class="col">
                                <input id="author" name = "Author" secondaryTextclass="form-control"  aria-describedby="inputHelp">
                            </div>
                            <div class="col">
                                <input type="hidden" name="IsVisible" value="false"/>
                                <input id="isVisible" name="IsVisible" type="checkbox" value="true" class="form-check-input">
                                <label class="form-check-label" for="exampleCheck1">Is visible</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="exampleInputEmail1">What words have changed you, influenced your life?</label>
                            <input id="primaryText" name="PrimaryText" type="textarea" class="form-control"  rows ="4">
                        </div>
            
                        <div class="form-group">
                            <label for="exampleInputEmail1">What would you wish to other people?</label>
                            <input id="secondaryText" name="SecondaryText" type="textarea" class="form-control" rows ="3">
                        </div>
                    </form>
                </div>
            
                <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary butomSave">Save changes</button>
                </div>
            </div>
            </div>
        </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script>
        var api = "https://localhost:5001/manage/quoteitem";

        $(document).ready(function(){
            $(".addrow").click(addnewrow);
            $(".butomSave").click(savechanges);

            $.getJSON(api, {
                }).done(function(data){
                    data.forEach(record => addrow(record));
                   
                })                              
            });

        function editrow(obj){
            var $id = $(obj).data("id"); 
            $.getJSON(api+"/"+$id, {
            }).done(function(data){
                $("#id").val(data.id);
                $('#quoteModal').data("id", data.id);  
                $("#primaryText").val(data.primaryText);
                $("#secondaryText").val(data.secondaryText);
                $("#author").val(data.author);
                $("#postTime").val(data.postTime);
                $("#isVisible").attr('checked',data.isVisible);
                $('#quoteModal').modal();   
            }) 
        };

        function addnewrow(){
            $("#id").prop( "disabled", true );
            $("#postTime").prop( "disabled", true );
            $('#quoteModal').modal();   
        };

        function deleterow(obj)
        {
            var $id = $(obj).data("id");
            $.ajax({
                url: api+"/"+$id,
                type: 'delete',
                crossdomain: true,
                success: function(data) {
                    $('#' + $id).remove();
                    alert("Delete sucefully!")
                },
        }); 
        }

        function alert(message){
            $('#alert').html('<div class="alert alert-secondary"><a class="close" data-dismiss="alert">Ã—</a><span>'+message+'</span></div>');
            $('.alert').alert()
        }

        function savechanges()
        {
            var $id = $("#quoteModal").data("id"); 
            if($id=="")
            {
                $.ajax({
                    url: api,
                    type: 'post',
                    crossdomain: true,
                    contentType: 'application/json',
                    dataType: 'json',
                    processData: false,
                    data: JSON.stringify(objectifyForm($('#editform').serializeArray())),
                    success: function(data) {
                        $('#quoteModal').modal('hide');
                            alert("New item was added sucefully!")
                            var row = '<tr id= "'+ data.id +'"><td scope="row">' + data.id + '</td>' +
                                        '<td>' + data.primaryText + '</td>' +
                                            '<td>' + data.secondaryText + '</td>' +
                                                '<td>' + data.author + '</td>' +
                                                    '<td>' + data.postTime + '</td>' +
                                                        '<td>' + data.isVisible + '</td>' +
                                                            '<td> <button type="button" onclick="editrow(this)" data-id ="' + data.id +  '"class="btn btn-outline-primary editrow">Edit</button></td>' +
                                                            '<td> <button type="button" onclick="deleterow(this)" data-id ="' + data.id +  '"class="btn btn-outline-danger deleterow">Delete</button></td>' +  
                                                    '</tr>';
                            $('#recordsTable tr:first').after(row); 
                        },
                        done: function()
                        {
                            $('#quoteModal').modal('hide');   
                        }
                        });
            }
            else
            {
                $.ajax({
                    url: api+"/"+$id,
                    type: 'put',
                    crossdomain: true,
                    contentType: 'application/json',
                    dataType: 'json',
                    processData: false,
                    data: JSON.stringify(objectifyForm($("#editform").serializeArray())),
                    success: function(data) {
                        $('#quoteModal').modal('hide');
                            $('#' + $id).html(
                                '<td>' + data.id + '</td>' +
                                    '<td>' + data.primaryText + '</td>' +
                                        '<td>' + data.secondaryText + '</td>' +
                                            '<td>' + data.author + '</td>' +
                                                '<td>' + data.postTime + '</td>' +
                                                     '<td>' + data.isVisible + '</td>' +
                                                        '<td> <button type="button" onclick="editrow(this)" data-id ="' + data.id +  '"class="btn btn-outline-primary editrow">Edit</button></td>' +
                                                        '<td> <button type="button" onclick="deleterow(this)" data-id ="' + data.id +  '"class="btn btn-outline-danger deleterow">Delete</button></td>'

                            )
                        },
                        done: function()
                        {
                            $('#quoteModal').modal('hide');   
                        }
                        });
            }
        };

        function addrow(data){
            var row = '<tr id= "'+ data.id +'"><td scope="row">' + data.id + '</td>' +
                        '<td>' + data.primaryText + '</td>' +
                            '<td>' + data.secondaryText + '</td>' +
                                '<td>' + data.author + '</td>' +
                                    '<td>' + data.postTime + '</td>' +
                                        '<td>' + data.isVisible + '</td>' +
                                            '<td> <button type="button" onclick="editrow(this)" data-id ="' + data.id +  '"class="btn btn-outline-primary editrow">Edit</button></td>' +
                                            '<td> <button type="button" onclick="deleterow(this)" data-id ="' + data.id +  '"class="btn btn-outline-danger deleterow">Delete</button></td>' +  
                                      '</tr>';
                $('#recordsTable tr:last').after(row); 
                                            
        };

        function objectifyForm(formArray) {
            var returnArray = {};
            for (var i = 0; i < formArray.length; i++)
            {
               if(!formArray[i].disabled)
                    returnArray[formArray[i]['name']] = formArray[i]['value'];
            }
            return returnArray;
        };
    </script>
  </body>
</html>